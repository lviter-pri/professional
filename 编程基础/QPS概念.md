# QPS概念

QPS（Queries Per Second，每秒查询率）是评估系统性能的核心指标

## 分析

1. **基础计算公式**

   QPS = 总请求数/总时间（秒）

   1. 适用：已知具体请求量和场景
   2. 举例：如果一个接口10s内收到了1000个请求，那么接口QPS=1000/10=100
   3. 场景：统计已产生的历史数据

2. **性能推导公式**

   QPS = 并发数/平均响应时间（秒）

   1. 适用：系统设计和压测中，这个系统峰值更有参考意义
   2. 举例：如果有1000个并发线程，每个请求处理200ms，那么理论峰值QPS=1000/0.2=5000
   3. 场景：压测评估、系统调优

3. **实际业务计算公式**

   QPS = (日总请求量x80%)/(日总秒数x20%)

   1. 适用：实际业务场景中，不能只看均值，必须考虑峰值流量，所以电商/社交领域常用的经验法则为二八定律：即80%的请求集中在20%的时间内
   2. 举例：全天100万次请求，有效时间24小时=24x3600=86400秒。那么峰值QPS=(1000000x0.8)/(86400x0.2)=800000/17280=46.3
   3. 场景：针对新功能上线的资源储备方案

4. **影响QPS的关键因素**

   1. 硬件资源：CPU核心数，内存宽带，磁盘I/O速度
   2. 代码效率：算法复杂度，是否异步处理等
   3. 外部依赖：数据库查询效率、缓存命中率、第三方接口的响应等
   4. 网络带宽：大数据量传输时，网络带宽可能成为瓶颈

   由上面的关键因素，优化方向优先级应该是，4-->3-->2-->1。尽量不使用大数据量网络传输；数据库查询索引优化，使用中间件缓存，第三方接口是否可以异步；代码优化，精简查询；硬件升级



## 具体场景

**需求：**提供一个API，日调用量大概两千万次，上午9点-12点，14点到20点为业务高峰，估算容量

**解决：**

1. 核心数据拆解

   1. 日总请求量：20000000（2000万）
   2. 业务高峰期：9小时=32400秒
      1. 上午9-12，3小时
      2. 下午14-20，6小时

2. QPS梯度计算

   A. 理论平均QPS：不考虑峰值，全天均分布的情况：20000000/86400=231

   B. 业务高峰平均QPS（基于二八定律）：假设80%（1600万）的请求集中在9个小时业务高峰期内，(20000000x0.8)/32400=494

   C. 系统设计目标QPS（冗余与应对突发流量）：应对瞬时流量-比如10点刚上班或14点刚开工的瞬间，需要高峰平均值冗余2-3倍。设计目标QPS=500x2=1000

3. 资源容量估算(以1000QPS为目标)

   | **维度**              | **参数假设** | **计算说明**                           |
   | --------------------- | ------------ | -------------------------------------- |
   | **平均响应时间 (RT)** | 100ms        | 典型内网API耗时                        |
   | **单机并发能力**      | 100 并发     | 假设 4 核 8G 机器，合理并发数为 100    |
   | **单机 QPS 能力**     | 1000 QPS     | 100 / 0.1s = 1000                      |
   | **所需实例数**        | **2 台**     | 1 台承载流量，1 台作为高可用冗余 (N+1) |

4. 关键系统瓶颈核查

   1. 数据库Mysql
      1. 1000QPS如果都是写的操作，压力较大，需要考虑读写分离
      2. 如果仅是读操作且有索引，单机MYSQL可以使用连接池优化
   2. 带宽
      1. 假设每个API响应报文10KB
      2. 1000QPS x 10KB=10MB/s
      3. 转换宽带：10MB/s x 8 = 80Mbps。需要确认服务器出口带宽是否够
   3. 连接池

5. 总结

   1. 日常高峰QPS约为500
   2. 系统应该以1000QPS进行设计和压测
   3. 至少2台4核8G的云服务器，负载均衡后，建议带宽不低于100Mbps


